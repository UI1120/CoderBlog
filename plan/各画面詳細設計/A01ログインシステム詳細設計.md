# A01 ログインシステム詳細設計

## 1. 画面概要

管理画面（ダッシュボードやエディター）にアクセスするための認証画面。
新規アカウント作成時は、送付されたワンタイムパスワード（OTP）を使用して初回ログインを行い、強制的にパスワード変更を求める。

## 2. 必要なフォームデータ

- `login_name`: ユーザー名（または ID）
- `password`: パスワード（新規アカウントの場合は通知された OTP を入力）

## 3. I/O（API フォーマット）

### 3.1. ログイン実行

- **メソッド**: `POST`
- **エンドポイント**: `/api/login`

#### Request JSON

```json
{
  "userId": "user123",
  "password": "password_here_or_otp"
}
```

#### Response JSON (Success)

```json
{
  "status": "success",
  "message": "Logged in successfully",
  "user": {
    "account_id": 1,
    "login_name": "user123",
    "display_name": "山田 太郎",
    "role": "admin"
  },
  "needs_password_change": false
}
```

※ `needs_password_change` が `true` の場合、フロントエンドはログイン処理を完了させる前にパスワード変更フォームを表示する。

#### Response JSON (Error)

```json
{
  "status": "error",
  "message": "Invalid username or password"
}
```

### 3.2. ログイン状態確認（ページロード時に使用）

- **メソッド**: `GET`
- **エンドポイント**: `/api/auth`

#### Response JSON (Success)

```json
{
  "is_authenticated": true,
  "user": {
    "account_id": 1,
    "login_name": "user123",
    "display_name": "山田 太郎",
    "role": "admin"
  },
  "needs_password_change": false
}
```

#### Response JSON (Unauthenticated)

```json
{
  "is_authenticated": false
}
```

### 3.3. 初回ログイン時のパスワード変更

- **メソッド**: `POST`
- **エンドポイント**: `/api/admin/accounts/{id}`

#### Request JSON

```json
{
  "password": "new_secure_password"
}
```

## 4. 認証フロー（OTP）

1. 管理者によってアカウントが作成される。
2. システムは `needs_password_change: true` の状態でアカウントを作成し、自動生成した OTP をメールで通知する。
3. ユーザーはログイン画面で `Account ID` と `OTP` (パスワード欄) を入力。
4. ログイン成功レスポンスの `needs_password_change: true` を検知し、フロントエンドは「パスワード設定画面」を表示。
5. ユーザーが新パスワード（8-12文字、英数混合）を設定し送信。
6. 設定完了後、ダッシュボードへリダイレクトされる。
